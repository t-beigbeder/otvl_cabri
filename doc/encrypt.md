# Handling encrypted data with Cabri DSS

Data is encrypted with public keys that are managed as identities.
The configuration of identities that are used for encryption and decryption
is explained on the page [Client configuration](cliconf.md).

Encryption and decryption are closely linked to [ACL](acl.md),
so a basic understanding of the way they work is required.

Each identity is referred to by its alias, and identity aliases
are used as ACL users for the purpose of synchronization.

## Default ACL for synchronization

As the default ACL mapping for synchronization is `:`, this maps the default system user
with the empty identity alias `""`.
For convenience, a default identity with this alias is generated by the system
but you should always keep control over it,
for instance by making a backup of the configuration or by storing the generated credentials
with a password manager such as [KeePass](https://keepass.info/).

For instance, sharing a source directory `cabri_samples/simple`
with two users: `u1` (yourself) in read-write and `u2` (a friend) in read-only
into an `xolf` encrypted DSS `cabri_xolf/xolfsimpleacl`.

    cabri cli config --gen u1
    cabri cli config --put u2 age1<user u2 public key>
    cabri cli dss make xolf:/home/guest/cabri_xolf/xolfsimpleacl -s s
    cabri cli sync fsy:/home/guest/cabri_samples/simple@ xolf:/home/guest/cabri_xolf/xolfsimpleacl@ --acl u1: --acl u2:rx --macl :u1 --macl :u2 -u u1 -r

To synchronize it back with both users in dedicated directories, simply use

    cabri cli sync xolf:/home/guest/cabri_xolf/xolfsimpleacl@ fsy:/home/guest/cabri_samples/simpleback1@ --macl u1: --leftuser u1 -r
    cabri cli sync xolf:/home/guest/cabri_xolf/xolfsimpleacl@ fsy:/home/guest/cabri_samples/simpleback2@ --acl :rx --macl u2: --leftuser u2 -r

## Multi-user synchronization with encrypted data

Using the previously discussed mapping between users and rights,
we can easily implement a multi-user synchronization.
Given the previous example, assuming that `cabri_samples/simple` contains
three directories

- `d1` that is owned by user `u1`,
- `d2` that is owned by user `u2`,
- `d3` that is shared by both

Sharing into an `xolf` encrypted DSS `cabri_xolf/xolfsimplesas`

    cabri cli dss make xolf:/home/guest/cabri_xolf/xolfsimplesas -s s
    cabri cli dss mkns xolf:/home/guest/cabri_xolf/xolfsimplesas@ -c d1/ -c d2/ -c d3/ --acl u1: --acl u2:
    cabri cli sync fsy:/home/guest/cabri_samples/simple@d1 xolf:/home/guest/cabri_xolf/xolfsimplesas@d1 --acl u1: --acl u2:rx --macl :u1 --macl :u2 -u u1 -r
    cabri cli sync fsy:/home/guest/cabri_samples/simple@d2 xolf:/home/guest/cabri_xolf/xolfsimplesas@d2 --acl u1:rx --acl u2: --macl :u1 --macl :u2 -u u1 -r
    cabri cli sync fsy:/home/guest/cabri_samples/simple@d3 xolf:/home/guest/cabri_xolf/xolfsimplesas@d3 --acl u1: --acl u2: --macl :u1 --macl :u2 -u u1 -r

To synchronize them back with both users in dedicated directories, simply use

    mkdir /home/guest/cabri_samples/simplesync1/d1 /home/guest/cabri_samples/simplesync1/d2 /home/guest/cabri_samples/simplesync1/d3
    cabri cli sync fsy:/home/guest/cabri_samples/simplesync1@d1 olf:/home/guest/cabri_olf/olfsimplesas@d1 --acl u1: --acl u2:rx --macl :u1 --macl :u2 --bidir -u u1 -r
    cabri cli sync olf:/home/guest/cabri_olf/olfsimplesas@d2 fsy:/home/guest/cabri_samples/simplesync1@d2 --acl :rx --macl u1: --leftuser u1 -r
    cabri cli sync fsy:/home/guest/cabri_samples/simplesync1@d3 olf:/home/guest/cabri_olf/olfsimplesas@d3 --acl u1: --acl u2: --macl :u1 --macl :u2 --bidir -u u1 -r

    mkdir /home/guest/cabri_samples/simplesync2/d1 /home/guest/cabri_samples/simplesync2/d2 /home/guest/cabri_samples/simplesync2/d3
    cabri cli sync xolf:/home/guest/cabri_xolf/xolfsimplesas@d1 fsy:/home/guest/cabri_samples/simplesync2@d1 --acl :rx --macl u2: --leftuser u2 -r
    cabri cli sync fsy:/home/guest/cabri_samples/simplesync2@d2 xolf:/home/guest/cabri_xolf/xolfsimplesas@d2 --acl u1:rx --acl u2: --macl :u1 --macl :u2 --bidir -u u2 -r
    cabri cli sync fsy:/home/guest/cabri_samples/simplesync2@d3 xolf:/home/guest/cabri_xolf/xolfsimplesas@d3 --acl u1: --acl u2: --macl :u1 --macl :u2 --bidir -u u2 -r

## Accessing encrypted DSS with an HTTP server

An HTTP server can be configured for serving access to an encrypted DSS as usual,
for instance:

    cabri cli dss make xolf:/home/guest/cabri_xolf/xolfsimpleacl -s s
    cabri webapi xolf+http://localhost:3000/home/guest/cabri_xolf/xolfsimpleacl@demo &

DSS commands must use a special `xwebapi+http` prefix instead of `webapi+http` for the DSS type,
for instance:

    cabri cli sync fsy:/home/guest/cabri_samples/simple@ xwebapi+http://localhost:3000/demo@ --acl u1: --acl u2:rx --macl :u1 --macl :u2 -u u1 -r